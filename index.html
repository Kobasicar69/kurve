<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Као Галерија</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',Tahoma, Geneva, Verdana, sans-serif}
    body{background:#000;color:#fff;padding:20px;min-height:100vh;overflow-x:hidden}
    header{ text-align:center;margin-bottom:30px;padding:20px;border-bottom:2px solid #ff6600 }
    h1{ color:#ff6600;font-size:2.2rem;text-shadow:0 0 10px rgba(255,102,0,.7);margin-bottom:6px }
    .subtitle{ color:#ccc;font-size:1rem }

    .gallery{
      display:grid;
      grid-template-columns:repeat(5,1fr);
      gap:15px;
      max-width:1400px;
      margin:0 auto;
    }

    .image-container, .video-container{
      position:relative;
      overflow:hidden;
      border-radius:8px;
      border:3px solid #333;
      transition: box-shadow 0.4s ease, border-color 0.4s ease;
      aspect-ratio:1/1;
      background:linear-gradient(180deg,#050505,#0b0b0b);
      box-shadow:0 4px 15px rgba(0,0,0,.8);
    }
    .image-container:hover, .video-container:hover{
      border-color:#ff6600;
      box-shadow:0 0 30px rgba(255,102,0,.9), 0 0 40px rgba(255,102,0,.6);
    }

    .image-container img, .video-container video{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      transition: transform .5s ease, filter .4s ease;
    }
    .image-container:hover img, .video-container:hover video{
      transform:scale(1.15);
      filter:brightness(.7) contrast(1.08);
    }

    .video-icon {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(0,0,0,0.7);
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ff6600;
      font-size: 12px;
      z-index: 2;
    }

    .lazy-placeholder {
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, #1a1a1a 25%, #0f0f0f 25%, #0f0f0f 50%, #1a1a1a 50%, #1a1a1a 75%, #0f0f0f 75%, #0f0f0f);
      background-size: 20px 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ff6600;
      font-size: 14px;
      position:absolute; inset:0;
    }

    /* Fullscreen modal */
    .modal{ 
      display:none; 
      position:fixed; 
      inset:0; 
      background:rgba(0,0,0,.95); 
      z-index:1000; 
      justify-content:center; 
      align-items:center; 
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .modal.active{ 
      display:flex;
      opacity: 1;
    }
    .modal-img-container, .modal-video-container {
      position: relative;
      max-width: 90%;
      max-height: 86vh;
    }
    .modal-img, .modal-video{ 
      max-width:100%; 
      max-height:86vh; 
      object-fit:contain; 
      border:5px solid #ff6600; 
      border-radius:10px; 
      box-shadow:0 0 40px rgba(255,102,0,.9);
      opacity: 1;
      transition: opacity 0.3s ease;
      background:#000;
    }
    .modal-img.fade-out, .modal-video.fade-out {
      opacity: 0;
    }
    .close-btn{ 
      position:absolute; 
      top:20px; 
      right:30px; 
      font-size:40px; 
      color:#ff6600; 
      cursor:pointer; 
      background:none; 
      border:none; 
      z-index:1001; 
      transition:transform .2s, text-shadow .2s 
    }
    .close-btn:hover{ 
      transform:scale(1.12); 
      text-shadow:0 0 15px rgba(255,102,0,1) 
    }

    .nav-btn{
      position:absolute; 
      top:50%; 
      transform:translateY(-50%);
      background:rgba(0,0,0,.5); 
      color:#ff6600; 
      border:2px solid #ff6600;
      width:50px;
      height:50px;
      border-radius:50%;
      font-size:30px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      z-index:1001;
      transition:background .2s,color .2s,box-shadow .2s;
    }
    .nav-btn:hover{ 
      background:#ff6600;
      color:#000; 
      box-shadow:0 0 20px rgba(255,102,0,.9) 
    }
    .prev-btn{ left:20px } 
    .next-btn{ right:20px }

    .image-counter{ 
      position:absolute; 
      bottom:20px; 
      left:50%; 
      transform:translateX(-50%); 
      color:#ff6600; 
      background:rgba(0,0,0,.7); 
      padding:6px 14px; 
      border-radius:20px; 
      border:1px solid #ff6600 
    }

    footer{ 
      text-align:center;
      margin-top:40px;
      padding:20px;
      color:#666;
      border-top:1px solid #333 
    }

    .music-indicator{ 
      position:fixed; 
      bottom:20px; 
      right:20px; 
      background:rgba(255,102,0,.18); 
      border:1px solid #ff6600; 
      border-radius:50%; 
      width:60px; 
      height:60px; 
      display:flex; 
      justify-content:center; 
      align-items:center; 
      color:#ff6600; 
      font-size:20px; 
      z-index:100;
      animation: pulse 2s infinite;
    }

    /* Audio-unlock overlay (for iOS/Safari) */
    #audio-unlock {
      position: fixed;
      inset: 0;
      display: none;
      z-index: 20000;
      align-items: center;
      justify-content: center;
      background: linear-gradient(180deg, rgba(0,0,0,0.9), rgba(0,0,0,0.95));
      color: #fff;
      text-align: center;
      padding: 20px;
    }
    #audio-unlock.show { display:flex; }
    #audio-unlock .box {
      border-radius: 12px;
      padding: 22px;
      border: 2px solid rgba(255,122,0,0.9);
      background: rgba(20,20,20,0.8);
      max-width: 420px;
    }
    #audio-unlock button {
      margin-top:12px;
      background: var(--accent, #ff6600);
      color: #000;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
    }

    .kurva-text {
      position: absolute;
      width: 100%;
      height: 100%;
      animation: spin 10s linear infinite;
    }
    .kurva-text span {
      position: absolute;
      left: 50%;
      top: 0;
      transform-origin: 0 30px;
      font-size: 10px;
      font-weight: bold;
      text-transform: uppercase;
    }

    @keyframes pulse{ 
      0%{box-shadow:0 0 0 0 rgba(255,102,0,.7);}
      70%{box-shadow:0 0 0 15px rgba(255,102,0,0);}
      100%{box-shadow:0 0 0 0 rgba(255,102,0,0);} 
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media(max-width:1200px){ .gallery{ grid-template-columns:repeat(4,1fr) } }
    @media(max-width:900px){ .gallery{ grid-template-columns:repeat(3,1fr) } }
    @media(max-width:600px){ .gallery{ grid-template-columns:repeat(2,1fr); } h1{ font-size:1.8rem } }
    @media(max-width:400px){ .gallery{ grid-template-columns:1fr } }
  </style>
</head>
<body>
  <header>
    <h1>К.П.Ч.</h1>
    <p class="subtitle">Једном курва, увек курва</p>
  </header>

  <div class="gallery" id="gallery"></div>

  <div class="modal" id="modal" aria-hidden="true">
    <button class="close-btn" id="close-btn" aria-label="Close">×</button>
    <div class="modal-img-container" id="modal-img-container">
      <img class="modal-img" id="modal-img" alt="Full view">
    </div>
    <div class="modal-video-container" id="modal-video-container" style="display:none">
      <video class="modal-video" id="modal-video" controls></video>
    </div>
    <button class="nav-btn prev-btn" id="prev-btn" aria-label="Previous">&#10094;</button>
    <button class="nav-btn next-btn" id="next-btn" aria-label="Next">&#10095;</button>
    <div class="image-counter" id="image-counter">1 / 446</div>
  </div>

  <footer><p>Сликано Андријаниним апаратом &copy; 2025 | боје су познате</p></footer>

  <div class="music-indicator" title="Music is playing">
    <div class="kurva-text" id="kurva-text"></div>
    ♪
  </div>

  <!-- Audio -->
  <audio id="bg-music" class="audio-player" loop playsinline preload="auto" crossorigin="anonymous">
    <source src="media/Kurva%20ka%C5%BEe.mp3" type="audio/mpeg">
    Your browser does not support audio.
  </audio>

  <!-- iOS / Safari audio unlock overlay -->
  <div id="audio-unlock" role="dialog" aria-modal="true">
    <div class="box">
      <div style="font-size:18px;color:#ffb17a;font-weight:700">Tap to enable sound</div>
      <div style="margin-top:8px;color:#ddd;font-size:14px">iOS Safari requires a tap to allow audio. Tap once and audio will play in background.</div>
      <button id="unlock-btn">Enable sound</button>
    </div>
  </div>

  <script>
    // DOM references
    const gallery = document.getElementById('gallery');
    const modal = document.getElementById('modal');
    const modalImg = document.getElementById('modal-img');
    const modalImgContainer = document.getElementById('modal-img-container');
    const modalVideo = document.getElementById('modal-video');
    const modalVideoContainer = document.getElementById('modal-video-container');
    const closeBtn = document.getElementById('close-btn');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const imageCounter = document.getElementById('image-counter');
    const bgMusic = document.getElementById('bg-music');
    const kurvaText = document.getElementById('kurva-text');

    const audioUnlock = document.getElementById('audio-unlock');
    const unlockBtn = document.getElementById('unlock-btn');

    // Store media paths and types
    let mediaUrls = [];
    let mediaData = [];

    // Keep track of background volume state
    let prevBgVolume = 1;

    // Lazy loading configuration
    const lazyLoadConfig = {
      rootMargin: '200px',
      threshold: 0.01
    };

    // Detect iOS / Safari where we need explicit unlock
    function isIOS() {
      return /iP(hone|od|ad)/.test(navigator.platform) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    }
    function isSafari() {
      return /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
    }
    const needsAudioUnlock = isIOS() && isSafari();

    // Create spinning KURVA text
    function createKurvaText() {
      const text = "КУРВА";
      for (let i = 0; i < text.length; i++) {
        const span = document.createElement('span');
        span.textContent = text[i];
        span.style.transform = `rotate(${i * (360 / text.length)}deg)`;
        kurvaText.appendChild(span);
      }
    }

    // Load media element (image/video)
    function loadMediaElement(mediaElement, src, placeholder) {
      if (mediaElement.tagName === 'IMG') {
        mediaElement.src = src;
        mediaElement.onload = () => {
          if (placeholder) placeholder.style.display = 'none';
        };
      } else if (mediaElement.tagName === 'VIDEO') {
        mediaElement.src = src;
        mediaElement.preload = 'metadata';
        mediaElement.onloadedmetadata = () => {
          if (placeholder) placeholder.style.display = 'none';
          try { mediaElement.currentTime = 0.1; } catch(e){}
        };
        mediaElement.addEventListener('loadstart', () => {
          try { mediaElement.pause(); } catch(e){}
        });
      }
    }

    // Lazy load setup using IntersectionObserver
    function setupLazyLoading() {
      const lazyMediaObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const container = entry.target;
            const mediaElement = container.querySelector('img, video');
            const placeholder = container.querySelector('.lazy-placeholder');
            if (mediaElement && mediaElement.dataset && mediaElement.dataset.src) {
              loadMediaElement(mediaElement, mediaElement.dataset.src, placeholder);
              delete mediaElement.dataset.src;
            }
            observer.unobserve(container);
          }
        });
      }, lazyLoadConfig);

      // Observe all containers currently in DOM
      document.querySelectorAll('.image-container, .video-container').forEach(container => {
        lazyMediaObserver.observe(container);
      });
    }

    // Load manifest.json and build gallery (keeps lazy placeholders)
    async function loadGallery() {
      try {
        const response = await fetch('./media/manifest.json');
        const manifest = await response.json();

        mediaData = manifest;
        mediaUrls = mediaData.map(item => item.path);

        mediaData.forEach((item, index) => {
          let cell, mediaElement;
          
          if (item.type === 'image') {
            cell = document.createElement('div');
            cell.className = 'image-container';
            cell.style.position = 'relative';

            const placeholder = document.createElement('div');
            placeholder.className = 'lazy-placeholder';
            placeholder.textContent = `${index + 1}`;
            cell.appendChild(placeholder);

            mediaElement = document.createElement('img');
            mediaElement.dataset.src = item.path;
            mediaElement.alt = item.filename || `Image ${index + 1}`;
          } else {
            cell = document.createElement('div');
            cell.className = 'video-container';
            cell.style.position = 'relative';

            const placeholder = document.createElement('div');
            placeholder.className = 'lazy-placeholder';
            placeholder.textContent = `${index + 1}`;
            cell.appendChild(placeholder);

            mediaElement = document.createElement('video');
            mediaElement.dataset.src = item.path;
            mediaElement.setAttribute('preload', 'metadata');
            mediaElement.setAttribute('muted', 'true');
            mediaElement.setAttribute('playsinline', '');
            mediaElement.muted = true;

            const videoIcon = document.createElement('div');
            videoIcon.className = 'video-icon';
            videoIcon.innerHTML = '▶';
            cell.appendChild(videoIcon);
          }

          mediaElement.dataset.index = index;
          mediaElement.dataset.type = item.type;

          cell.appendChild(mediaElement);
          gallery.appendChild(cell);

          // Click opens modal
          cell.addEventListener('click', () => openModal(index));
        });

        // Initialize IntersectionObservers for elements just added
        setupLazyLoading();

      } catch (error) {
        console.error('Error loading manifest:', error);
        gallery.innerHTML = '<div style="text-align:center;grid-column:1/-1;padding:20px;color:#ff6600;">Error loading media. Please check if manifest.json exists.</div>';
      }
    }

    // Modal controls & state
    let currentIndex = 0;
    let isTransitioning = false;
    let isVideoPlaying = false;

    function openModal(i) {
      currentIndex = i;
      const mediaItem = mediaData[i];

      if (mediaItem.type === 'image') {
        modalImgContainer.style.display = 'block';
        modalVideoContainer.style.display = 'none';
        modalImg.src = mediaItem.path;

        // restore background volume if not a playing video
        if (!isVideoPlaying) tryRestoreBgVolume();
      } else {
        modalImgContainer.style.display = 'none';
        modalVideoContainer.style.display = 'block';

        // Reset video element
        modalVideo.pause();
        modalVideo.currentTime = 0;
        modalVideo.muted = false;

        // Load video
        modalVideo.src = mediaItem.path;
        modalVideo.load();

        // When video plays, mute BG by setting volume to 0 (store prev)
        modalVideo.onplay = () => {
          tryStoreAndMuteBg();
          isVideoPlaying = true;
        };
        modalVideo.onpause = () => {
          tryRestoreBgVolume();
          isVideoPlaying = false;
        };
        modalVideo.onended = () => {
          tryRestoreBgVolume();
          isVideoPlaying = false;
        };

        // Try to auto-play (may be blocked)
        modalVideo.oncanplay = () => {
          modalVideo.play().catch(() => {
            // blocked — user can press play
          });
        };
      }

      imageCounter.textContent = `${i + 1} / ${mediaUrls.length}`;
      modal.classList.add('active');
      modal.setAttribute('aria-hidden','false');
    }

    function closeModal(){
      if (!modalVideo.paused) {
        modalVideo.pause();
      }
      isVideoPlaying = false;
      tryRestoreBgVolume();
      modal.classList.remove('active');
      modal.setAttribute('aria-hidden','true');
    }

    function changeImageWithTransition(newIndex) {
      if (isTransitioning || newIndex === currentIndex) return;
      isTransitioning = true;

      const currentType = mediaData[currentIndex].type;

      if (currentType === 'image') modalImg.classList.add('fade-out');
      else modalVideo.classList.add('fade-out');

      setTimeout(() => {
        currentIndex = newIndex;
        const mediaItem = mediaData[currentIndex];

        if (mediaItem.type === 'image') {
          modalImgContainer.style.display = 'block';
          modalVideoContainer.style.display = 'none';
          modalImg.src = mediaItem.path;
          tryRestoreBgVolume();
        } else {
          modalImgContainer.style.display = 'none';
          modalVideoContainer.style.display = 'block';
          modalVideo.pause(); modalVideo.currentTime = 0; modalVideo.muted = false;
          modalVideo.src = mediaItem.path; modalVideo.load();

          modalVideo.onplay = () => { tryStoreAndMuteBg(); isVideoPlaying = true; };
          modalVideo.onpause = () => { tryRestoreBgVolume(); isVideoPlaying = false; };
          modalVideo.onended = () => { tryRestoreBgVolume(); isVideoPlaying = false; };

          modalVideo.oncanplay = () => { modalVideo.play().catch(()=>{}); };
        }

        imageCounter.textContent = `${currentIndex + 1} / ${mediaUrls.length}`;

        modalImg.classList.remove('fade-out');
        modalVideo.classList.remove('fade-out');

        setTimeout(()=>{ isTransitioning = false; }, 300);
      }, 300);
    }

    closeBtn.addEventListener('click', closeModal);
    prevBtn.addEventListener('click', () => {
      const newIndex = (currentIndex - 1 + mediaUrls.length) % mediaUrls.length;
      changeImageWithTransition(newIndex);
    });
    nextBtn.addEventListener('click', () => {
      const newIndex = (currentIndex + 1) % mediaUrls.length;
      changeImageWithTransition(newIndex);
    });

    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeModal();
    });

    document.addEventListener('keydown', (e) => {
      if (!modal.classList.contains('active')) return;
      if (e.key === 'Escape') closeModal();
      else if (e.key === 'ArrowLeft') prevBtn.click();
      else if (e.key === 'ArrowRight') nextBtn.click();
    });

    // Audio controls: use volume instead of mute to avoid Safari blocking
    function tryStoreAndMuteBg() {
      try {
        prevBgVolume = (typeof bgMusic.volume === 'number') ? bgMusic.volume : 1;
        bgMusic.volume = 0;
      } catch(e){}
    }
    function tryRestoreBgVolume() {
      try {
        if (typeof prevBgVolume === 'number') bgMusic.volume = prevBgVolume;
        else bgMusic.volume = 1;
      } catch(e){}
    }

    // Smart autoplay attempt (non-ios)
    async function startMusicIfPossible(){
      if (!bgMusic) return;
      try {
        bgMusic.preload = 'auto';
        bgMusic.loop = true;
        bgMusic.volume = prevBgVolume;
        // Try direct play
        await bgMusic.play();
        console.log('Background music started automatically');
      } catch(err) {
        console.warn('Autoplay blocked or requires gesture', err);
        // do nothing — overlay or user gesture will enable it
      }
    }

    // Audio unlock overlay behavior
    function showAudioUnlock() {
      audioUnlock.classList.add('show');
    }
    function hideAudioUnlock() {
      audioUnlock.classList.remove('show');
    }

    async function unlockAudioNow() {
      try {
        // Try to play bgMusic as user gesture (should be allowed on iOS Safari)
        bgMusic.muted = false; // ensure unmuted
        bgMusic.volume = prevBgVolume || 1;
        await bgMusic.play();
        console.log('Audio unlocked via user gesture');
      } catch (err) {
        console.warn('unlockAudioNow: play failed, attempting muted play fallback', err);
        try {
          // fallback: play muted then unmute (still user gesture)
          bgMusic.muted = true;
          await bgMusic.play();
          bgMusic.muted = false;
          console.log('Fallback muted->unmute succeeded');
        } catch (err2) {
          console.warn('Fallback failed', err2);
        }
      } finally {
        hideAudioUnlock();
      }
    }

    // If mobile Safari, show overlay until user taps
    unlockBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      await unlockAudioNow();
    });

    // Also allow touching anywhere to unlock (useful on desktops & other browsers)
    function onFirstUserGesture() {
      unlockAudioNow().catch(()=>{});
      window.removeEventListener('touchstart', onFirstUserGesture, {passive:true});
      window.removeEventListener('click', onFirstUserGesture, {passive:true});
    }

    // Start sequence: create UI, load gallery, and decide whether to show unlock
    window.addEventListener('load', async () => {
      // create spinning text
      createKurvaText();
      // load gallery
      await loadGallery();
      // try to auto-play on non-safari
      if (!needsAudioUnlock) {
        startMusicIfPossible().catch(()=>{});
      } else {
        // show overlay for iOS Safari
        showAudioUnlock();
        // try to bind first-gesture unlock too
        window.addEventListener('touchstart', onFirstUserGesture, {passive:true});
        window.addEventListener('click', onFirstUserGesture, {passive:true});
      }
      // also attempt resume on any later gesture
      ['click','keydown','touchstart'].forEach(ev => {
        window.addEventListener(ev, () => {
          startMusicIfPossible().catch(()=>{});
        }, {passive:true});
      });
    });

    // Optional: If user interacts after video ended, ensure music resumes
    // (useful for Safari if the overlay isn't used)
    document.addEventListener('click', () => {
      if (bgMusic && bgMusic.paused === false && bgMusic.volume === 0) {
        // nothing
      } else {
        startMusicIfPossible().catch(()=>{});
      }
    }, {passive:true});
  </script>
</body>
</html>
